#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ ShadowFlow Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
# ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ubuntu/Debian ÑÐµÑ€Ð²ÐµÑ€Ñ‹

set -e

echo "ðŸš€ ShadowFlow Server Deployment"
echo "==============================="
echo ""

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
if [[ $EUID -eq 0 ]]; then
   error "ÐÐµ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ð¹Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ root. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ sudo Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸."
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
if ! command -v apt-get &> /dev/null; then
    error "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð´Ð»Ñ Ubuntu/Debian ÑÐ¸ÑÑ‚ÐµÐ¼"
fi

log "ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ ShadowFlow..."

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
log "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
sudo apt update && sudo apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
sudo apt install -y python3 python3-pip python3-venv nginx curl wget git build-essential cmake

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
if command -v docker &> /dev/null; then
    log "Docker ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
else
    log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    sudo usermod -aG docker $USER
    rm get-docker.sh
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
PROJECT_DIR="/home/$USER/shadowflow"
log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°: $PROJECT_DIR"
mkdir -p $PROJECT_DIR

# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
log "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
cp -r . $PROJECT_DIR/
cd $PROJECT_DIR

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Python Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
python3 -m venv venv
source venv/bin/activate

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip install --upgrade pip
pip install -r requirements.txt

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐ»ÑƒÐ¶Ð±Ñ‹
log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐ»ÑƒÐ¶Ð±Ñ‹..."
sudo tee /etc/systemd/system/shadowflow.service > /dev/null << EOF
[Unit]
Description=ShadowFlow - Polymarket Analysis System
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$PROJECT_DIR
Environment=PATH=$PROJECT_DIR/venv/bin
ExecStart=$PROJECT_DIR/venv/bin/python $PROJECT_DIR/start_24_7.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx
log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx..."
sudo tee /etc/nginx/sites-available/shadowflow > /dev/null << EOF
server {
    listen 80;
    server_name _;
    
    location / {
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        
        # WebSocket Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    location /static {
        alias $PROJECT_DIR/static;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ ÑÐ°Ð¹Ñ‚Ð° Nginx
sudo ln -sf /etc/nginx/sites-available/shadowflow /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx
sudo nginx -t || error "ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°
log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°..."
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw --force enable

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° systemd Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÑÐ»ÑƒÐ¶Ð±
log "Ð—Ð°Ð¿ÑƒÑÐº ÑÐ»ÑƒÐ¶Ð±..."
sudo systemctl daemon-reload
sudo systemctl enable shadowflow
sudo systemctl start shadowflow
sudo systemctl restart nginx

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
log "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐ»ÑƒÐ¶Ð±..."
sleep 5

if sudo systemctl is-active --quiet shadowflow; then
    log "âœ… ShadowFlow ÑÐ»ÑƒÐ¶Ð±Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
else
    error "âŒ ShadowFlow ÑÐ»ÑƒÐ¶Ð±Ð° Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð°ÑÑŒ"
fi

if sudo systemctl is-active --quiet nginx; then
    log "âœ… Nginx Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
else
    error "âŒ Nginx Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ"
fi

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ IP ÑÐµÑ€Ð²ÐµÑ€Ð°
SERVER_IP=$(curl -s ifconfig.me)
log "âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ IP: $SERVER_IP"

echo ""
echo "ðŸŽ‰ Ð ÐÐ—Ð’Ð•Ð Ð¢Ð«Ð’ÐÐÐ˜Ð• Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž!"
echo "============================"
echo ""
echo "ðŸŒ Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ: http://$SERVER_IP"
echo "ðŸ“Š Real-time: http://$SERVER_IP/realtime"
echo "ðŸ“¡ ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³: http://$SERVER_IP/monitoring"
echo ""
echo "ðŸŽ›ï¸ Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð•:"
echo "==============="
echo "sudo systemctl start shadowflow"
echo "sudo systemctl stop shadowflow"
echo "sudo systemctl restart shadowflow"
echo "sudo systemctl status shadowflow"
echo ""
echo "ðŸ“ Ð›ÐžÐ“Ð˜:"
echo "========"
echo "sudo journalctl -u shadowflow -f"
echo "tail -f $PROJECT_DIR/logs/24_7.log"
echo ""
echo "ðŸ³ DOCKER (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾):"
echo "========================"
echo "cd $PROJECT_DIR"
echo "docker-compose up -d"
echo ""
echo "ðŸŽ‰ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ 24/7!"
