{% extends "base.html" %}

{% block title %}Дашборд - ShadowFlow{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i> Дашборд анализа
        </h1>
    </div>
</div>

<!-- Метрики -->
<div class="row mb-4" id="metricsRow">
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-layer-group fa-2x mb-2"></i>
                <div class="metric-value" id="totalClusters">-</div>
                <div>Всего кластеров</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-wallet fa-2x mb-2"></i>
                <div class="metric-value" id="totalWallets">-</div>
                <div>Уникальных кошельков</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                <div class="metric-value" id="totalVolume">-</div>
                <div>Общий объем</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <div class="metric-value" id="avgSyncScore">-</div>
                <div>Средняя синхронность</div>
            </div>
        </div>
    </div>
</div>

<!-- Графики -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Топ рынки по кластерам</h5>
            </div>
            <div class="card-body">
                <canvas id="marketsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Распределение синхронности</h5>
            </div>
            <div class="card-body">
                <canvas id="syncScoreChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Актуальные события Polymarket -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-fire"></i> Актуальные события Polymarket
                </h5>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshPolymarketEvents()">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
            </div>
            <div class="card-body">
                <div id="polymarketEvents">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка событий...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Топ кластеры -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-exclamation-triangle"></i> Топ подозрительных кластеров</h5>
                <a href="/clusters" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye"></i> Показать все
                </a>
            </div>
            <div class="card-body">
                <div id="topClusters">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка кластеров...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let marketsChart = null;
let syncScoreChart = null;

// Загрузка данных при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadPolymarketEvents();
    
    // Обновляем события каждые 5 минут
    setInterval(loadPolymarketEvents, 300000);
});

async function loadPolymarketEvents() {
    try {
        const response = await fetch('/api/polymarket/events');
        const data = await response.json();
        
        if (data.success) {
            displayPolymarketEvents(data.events);
        } else {
            console.error('Ошибка загрузки событий:', data.error);
            document.getElementById('polymarketEvents').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Ошибка загрузки событий: ${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Ошибка при загрузке событий:', error);
        document.getElementById('polymarketEvents').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>Ошибка загрузки событий</p>
            </div>
        `;
    }
}

function displayPolymarketEvents(events) {
    const container = document.getElementById('polymarketEvents');
    
    if (events.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p>События не найдены</p>
            </div>
        `;
        return;
    }
    
    const eventsHtml = events.map((event, index) => {
        const volume = formatCurrency(event.volume);
        const liquidity = formatCurrency(event.liquidity);
        const endDate = event.end_date ? new Date(event.end_date).toLocaleDateString('ru-RU') : 'Не указана';
        
        return `
            <div class="card mb-3 event-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="event-title">
                                <a href="${event.url}" target="_blank" class="text-decoration-none event-link">
                                    ${event.question}
                                    <i class="fas fa-external-link-alt ms-1"></i>
                                </a>
                            </h6>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <span class="badge bg-info">
                                    <i class="fas fa-chart-bar"></i> ${volume}
                                </span>
                                <span class="badge bg-success">
                                    <i class="fas fa-coins"></i> ${liquidity}
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="fas fa-calendar"></i> ${endDate}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="event-rank">
                                <span class="badge bg-primary fs-6">#${index + 1}</span>
                            </div>
                            <a href="${event.url}" target="_blank" class="btn btn-outline-primary btn-sm mt-2">
                                <i class="fas fa-external-link-alt"></i> Открыть
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = eventsHtml;
}

function refreshPolymarketEvents() {
    const container = document.getElementById('polymarketEvents');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Обновление...</span>
            </div>
            <p class="mt-2">Обновление событий...</p>
        </div>
    `;
    loadPolymarketEvents();
}

async function loadDashboardData() {
    try {
        // Загружаем сводку
        const summaryResponse = await fetch('/api/summary');
        const summaryData = await summaryResponse.json();
        
        if (summaryData.success) {
            updateMetrics(summaryData.summary);
            updateCharts(summaryData.summary);
        }
        
        // Загружаем топ кластеры
        const clustersResponse = await fetch('/api/clusters');
        const clustersData = await clustersResponse.json();
        
        if (clustersData.success) {
            displayTopClusters(clustersData.clusters.slice(0, 5));
        }
        
    } catch (error) {
        console.error('Ошибка при загрузке данных:', error);
        showAlert('danger', 'Ошибка при загрузке данных дашборда');
    }
}

function updateMetrics(summary) {
    document.getElementById('totalClusters').textContent = formatNumber(summary.total_clusters || 0);
    document.getElementById('totalWallets').textContent = formatNumber(summary.total_unique_wallets || 0);
    document.getElementById('totalVolume').textContent = formatCurrency(summary.total_volume || 0);
    document.getElementById('avgSyncScore').textContent = (summary.avg_sync_score || 0).toFixed(1) + '%';
}

function updateCharts(summary) {
    // График топ рынков
    const marketsCtx = document.getElementById('marketsChart').getContext('2d');
    if (marketsChart) {
        marketsChart.destroy();
    }
    
    const topMarkets = summary.top_markets || [];
    marketsChart = new Chart(marketsCtx, {
        type: 'doughnut',
        data: {
            labels: topMarkets.map(m => m[0].substring(0, 30) + (m[0].length > 30 ? '...' : '')),
            datasets: [{
                data: topMarkets.map(m => m[1]),
                backgroundColor: [
                    '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // График распределения синхронности
    const syncCtx = document.getElementById('syncScoreChart').getContext('2d');
    if (syncScoreChart) {
        syncScoreChart.destroy();
    }
    
    // Создаем гистограмму синхронности (заглушка)
    syncScoreChart = new Chart(syncCtx, {
        type: 'bar',
        data: {
            labels: ['0-20%', '21-40%', '41-60%', '61-80%', '81-100%'],
            datasets: [{
                label: 'Количество кластеров',
                data: [0, 0, 0, 0, 0], // Будет обновлено при загрузке кластеров
                backgroundColor: '#3498db'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function displayTopClusters(clusters) {
    const container = document.getElementById('topClusters');
    
    if (clusters.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p>Кластеры не найдены. Попробуйте обновить данные.</p>
            </div>
        `;
        return;
    }
    
    // Загружаем информацию о рынках асинхронно
    loadMarketInfoAsync(clusters).then(marketInfoMap => {
        const clustersHtml = clusters.map((cluster, index) => {
            const marketInfo = marketInfoMap[cluster.market_id] || {
                name: cluster.market_name || `Market ${cluster.market_id}`,
                url: `https://polymarket.com/search?q=${cluster.market_id}`,
                description: cluster.market_question || 'Нет описания'
            };
            
            // Улучшаем отображение названия рынка
            let displayName = marketInfo.name;
            if (!displayName || displayName.startsWith('Market 0x') || displayName.length > 50) {
                displayName = cluster.market_question || `Market ${cluster.market_id.substring(0, 8)}...`;
            }
            
            return `
                <div class="card cluster-card ${getRiskClass(cluster.sync_score)} mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="market-name">
                                    <a href="${marketInfo.url}" target="_blank" class="text-decoration-none market-link" title="${marketInfo.name}">
                                        ${displayName}
                                        <i class="fas fa-external-link-alt ms-1"></i>
                                    </a>
                                </h6>
                                <p class="text-muted mb-2">${marketInfo.description}</p>
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge bg-${cluster.side === 'YES' ? 'success' : 'danger'}">
                                        ${cluster.side}
                                    </span>
                                    <span class="badge bg-info">
                                        <i class="fas fa-wallet"></i> ${cluster.wallets_count} кошельков
                                    </span>
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-exchange-alt"></i> ${cluster.trades_count} сделок
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="sync-score ${getSyncScoreClass(cluster.sync_score)}">
                                    ${cluster.sync_score.toFixed(1)}%
                                </div>
                                <div class="text-muted small">Синхронность</div>
                                <div class="fw-bold">${formatCurrency(cluster.total_volume)}</div>
                                <div class="text-muted small">Объем</div>
                                <div class="text-muted small">${cluster.time_window_str}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = clustersHtml;
    });
}

async function loadMarketInfoAsync(clusters) {
    const marketIds = [...new Set(clusters.map(c => c.market_id))];
    const marketInfoMap = {};
    
    // Загружаем информацию о рынках параллельно
    const promises = marketIds.map(async (marketId) => {
        try {
            const response = await fetch(`/api/market-info/${marketId}`);
            const data = await response.json();
            if (data.success) {
                marketInfoMap[marketId] = data.market;
            }
        } catch (error) {
            console.warn(`Не удалось загрузить информацию о рынке ${marketId}:`, error);
        }
    });
    
    await Promise.all(promises);
    return marketInfoMap;
}

// Обновляем график синхронности при загрузке кластеров
async function updateSyncScoreChart(clusters) {
    if (!syncScoreChart) return;
    
    const ranges = [0, 0, 0, 0, 0]; // 0-20, 21-40, 41-60, 61-80, 81-100
    
    clusters.forEach(cluster => {
        const score = cluster.sync_score;
        if (score <= 20) ranges[0]++;
        else if (score <= 40) ranges[1]++;
        else if (score <= 60) ranges[2]++;
        else if (score <= 80) ranges[3]++;
        else ranges[4]++;
    });
    
    syncScoreChart.data.datasets[0].data = ranges;
    syncScoreChart.update();
}
</script>
{% endblock %}
