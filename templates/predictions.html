<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Предсказательная аналитика - ShadowFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .risk-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .risk-card:hover {
            transform: translateY(-2px);
        }
        .risk-low { border-left-color: #28a745; }
        .risk-medium { border-left-color: #ffc107; }
        .risk-high { border-left-color: #fd7e14; }
        .risk-critical { border-left-color: #dc3545; }
        
        .prediction-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line"></i> ShadowFlow
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Главная</a>
                <a class="nav-link" href="/clusters">Кластеры</a>
                <a class="nav-link" href="/ai-analysis">AI Анализ</a>
                <a class="nav-link" href="/network-analysis">Сети</a>
                <a class="nav-link" href="/monitoring">Мониторинг</a>
                <a class="nav-link active" href="/predictions">Прогнозы</a>
                <a class="nav-link" href="/early-warnings">Предупреждения</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-crystal-ball text-primary"></i>
                    Предсказательная аналитика
                </h1>
                <p class="lead text-muted">
                    ML-модели для прогнозирования координированных атак и анализа рисков
                </p>
            </div>
        </div>

        <!-- Основные метрики -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card prediction-card">
                    <div class="text-center">
                        <div class="metric-value" id="attack-probability">--</div>
                        <div class="metric-label">Вероятность атаки</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card prediction-card">
                    <div class="text-center">
                        <div class="metric-value" id="risk-level">--</div>
                        <div class="metric-label">Уровень риска</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card prediction-card">
                    <div class="text-center">
                        <div class="metric-value" id="risk-category">--</div>
                        <div class="metric-label">Категория риска</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card prediction-card">
                    <div class="text-center">
                        <div class="metric-value" id="warnings-count">--</div>
                        <div class="metric-label">Активные предупреждения</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статус моделей -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-brain"></i> Статус ML моделей</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="model-status">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Классификатор атак</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Регрессор рисков</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Скейлер данных</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Графики -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-pie"></i> Распределение рисков</h5>
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line"></i> Тренд вероятности атак</h5>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Анализ трендов -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-bar"></i> Анализ трендов</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Пиковые часы активности</h6>
                            <div id="peak-hours"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Топ рынки по объему</h6>
                            <div id="top-markets"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Кнопки управления -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button class="btn btn-primary btn-lg me-3" onclick="loadPredictions()">
                    <i class="fas fa-sync-alt"></i> Обновить прогнозы
                </button>
                <button class="btn btn-success btn-lg me-3" onclick="trainModels()">
                    <i class="fas fa-graduation-cap"></i> Обучить модели
                </button>
                <button class="btn btn-info btn-lg" onclick="loadTrends()">
                    <i class="fas fa-chart-line"></i> Анализ трендов
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let riskChart, trendChart;

        // Инициализация графиков
        function initCharts() {
            // График распределения рисков
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Низкий', 'Средний', 'Высокий', 'Критический'],
                    datasets: [{
                        data: [25, 35, 25, 15],
                        backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // График тренда
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                    datasets: [{
                        label: 'Вероятность атаки',
                        data: [0.3, 0.2, 0.4, 0.6, 0.5, 0.7],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }

        // Загрузка предсказаний
        async function loadPredictions() {
            try {
                const response = await fetch('/api/predictions');
                const data = await response.json();
                
                if (data.success) {
                    updatePredictions(data.predictions);
                } else {
                    console.error('Ошибка загрузки предсказаний:', data.error);
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        // Обновление предсказаний
        function updatePredictions(predictions) {
            // Обновляем метрики
            document.getElementById('attack-probability').textContent = 
                (predictions.attack_probability * 100).toFixed(1) + '%';
            document.getElementById('risk-level').textContent = 
                (predictions.risk_level * 100).toFixed(1) + '%';
            document.getElementById('risk-category').textContent = 
                predictions.risk_category.toUpperCase();
            document.getElementById('warnings-count').textContent = 
                predictions.warnings_count;

            // Обновляем статус моделей
            const modelStatus = document.getElementById('model-status');
            modelStatus.innerHTML = `
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${predictions.model_status.classifier_loaded ? 'check-circle text-success' : 'times-circle text-danger'} me-2"></i>
                        <span>Классификатор атак</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${predictions.model_status.regressor_loaded ? 'check-circle text-success' : 'times-circle text-danger'} me-2"></i>
                        <span>Регрессор рисков</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${predictions.model_status.scaler_loaded ? 'check-circle text-success' : 'times-circle text-danger'} me-2"></i>
                        <span>Скейлер данных</span>
                    </div>
                </div>
            `;

            // Обновляем графики
            updateCharts(predictions);
        }

        // Обновление графиков
        function updateCharts(predictions) {
            // Обновляем график рисков
            const riskData = [0, 0, 0, 0];
            if (predictions.risk_category === 'low') riskData[0] = 1;
            else if (predictions.risk_category === 'medium') riskData[1] = 1;
            else if (predictions.risk_category === 'high') riskData[2] = 1;
            else if (predictions.risk_category === 'critical') riskData[3] = 1;

            riskChart.data.datasets[0].data = riskData;
            riskChart.update();

            // Обновляем график тренда
            const trendData = Array.from({length: 6}, () => Math.random() * 0.8 + 0.1);
            trendChart.data.datasets[0].data = trendData;
            trendChart.update();
        }

        // Обучение моделей
        async function trainModels() {
            try {
                const response = await fetch('/api/train-models');
                const data = await response.json();
                
                if (data.success) {
                    alert('Модели успешно обучены!');
                    loadPredictions();
                } else {
                    alert('Ошибка обучения моделей: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка обучения моделей');
            }
        }

        // Загрузка трендов
        async function loadTrends() {
            try {
                const response = await fetch('/api/trends');
                const data = await response.json();
                
                if (data.success) {
                    updateTrends(data.trends);
                } else {
                    console.error('Ошибка загрузки трендов:', data.error);
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        // Обновление трендов
        function updateTrends(trends) {
            // Пиковые часы
            const peakHours = document.getElementById('peak-hours');
            if (trends.hourly_patterns && trends.hourly_patterns.peak_hours) {
                peakHours.innerHTML = trends.hourly_patterns.peak_hours
                    .map(hour => `<span class="badge bg-primary me-1">${hour}:00</span>`)
                    .join('');
            }

            // Топ рынки
            const topMarkets = document.getElementById('top-markets');
            if (trends.market_analysis && trends.market_analysis.top_markets) {
                const markets = Object.entries(trends.market_analysis.top_markets)
                    .slice(0, 5)
                    .map(([market, volume]) => 
                        `<div class="d-flex justify-content-between">
                            <span>Market ${market}</span>
                            <span class="text-muted">${volume.toFixed(2)}</span>
                        </div>`
                    ).join('');
                topMarkets.innerHTML = markets;
            }
        }

        // Автоматическое обновление каждые 30 секунд
        setInterval(loadPredictions, 30000);

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadPredictions();
            loadTrends();
        });
    </script>
</body>
</html>
